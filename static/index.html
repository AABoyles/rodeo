<!DOCTYPE html>
<html lang="en">
<head>
    <title>Rodeo</title>
    <link href="css/styles.css" rel="stylesheet"/>

    <script type="text/javascript">
      window.$ = window.jQuery = require('jquery');
      Handlebars = require("handlebars");
      Handlebars.registerHelper('compare', function (lvalue, operator, rvalue, options) {

        var operators, result;

        if (arguments.length < 3) {
            throw new Error("Handlerbars Helper 'compare' needs 2 parameters");
        }

        if (options === undefined) {
            options = rvalue;
            rvalue = operator;
            operator = "===";
        }

        operators = {
            '==': function (l, r) { return l == r; },
            '===': function (l, r) { return l === r; },
            '!=': function (l, r) { return l != r; },
            '!==': function (l, r) { return l !== r; },
            '<': function (l, r) { return l < r; },
            '>': function (l, r) { return l > r; },
            '<=': function (l, r) { return l <= r; },
            '>=': function (l, r) { return l >= r; },
            'typeof': function (l, r) { return typeof l == r; }
        };

        if (!operators[operator]) {
            throw new Error("Handlerbars Helper 'compare' doesn't know the operator " + operator);
        }

        result = operators[operator](lvalue, rvalue);

        if (result) {
            return options.fn(this);
        } else {
            return options.inverse(this);
        }

    });
    </script>
    <script src="js/main.js"></script>
    <script src="ace/ace.js"></script>
    <script src="ace/ext-language_tools.js"></script>

    <script type="text/javascript">
      // Load in Handlebars templates
      var preferences_template = Handlebars.templates["preferences.hbs"];
      var editor_tab_template = Handlebars.templates["editor-tab.hbs"];
      var editor_template = Handlebars.templates["editor.hbs"];
      var active_variables_row_template = Handlebars.templates["active-variable.hbs"];
      var history_row_template = Handlebars.templates["history-row.hbs"];
      var package_row_template = Handlebars.templates["package-row.hbs"];
      var file_template = Handlebars.templates["file-item.hbs"];
      var wd_template = Handlebars.templates["wd.hbs"];
    </script>
</head>
<body>

  <!-- main section -->
  <div id="pane-container" class="">
      <div id="left-column">
        <!-- TOP LEFT -->
        <div id="top-left">
          <!-- editors -->
          <ul id="editorsTab" class="nav nav-tabs">
            <li>
              <img class="hat" src="img/cowboy-hat.svg" title="Yee Haw!" href="https://www.yhathq.com/">
              <a href="#"><span style="color: #ee5311;">&ycirc;</span><span class="color: #898989">hat</span></a>
            </li>
            <!-- editor tabs go here -->
            <li><a href="#" id="add-tab"><i class="fa fa-plus-square-o"></i></a></li>
          </ul>
          </ul>
          <div id="editors" class="tab-content">
          </div>
          <!-- end editors -->
        </div>
        <!-- END TOP LEFT -->

        <!-- BOTTOM LEFT -->
        <div id="bottom-left">
          <!-- <h3 class="panel-title"><i class="fa fa-terminal"></i></h3> -->
          <div id="console"></div>
        </div>
        <!-- END BOTTOM LEFT -->
    </div>
    <div id="right-column">
        <!-- TOP RIGHT -->
        <div id="top-right">
          <ul class="nav nav-tabs">
            <li class="active"><a href="#environment" data-toggle="tab"><i class="fa fa-table"></i>&nbsp;Data Frames</a></li>
            <li><a href="#history" data-toggle="tab"><i class="fa fa-history"></i>&nbsp;History</a></li>
          </ul>
          <div id="myTabContent" class="tab-content">
            <div class="tab-pane active in top-right" id="environment">
              <table class="table table-bordered" style="margin-bottom: 0px;">
                <thead>
                  <tr id="vars-header">
                    <th>variable</th>
                    <th>type</th>
                    <th></th>
                  </tr>
                </thead>
              </table>
              <table class="table table-bordered">
                <tbody id="vars">
                </tbody>
              </table>
            </div>
            <div class="tab-pane" id="history">
              <div class="row">
                <div class="col-sm-5 col-sm-offset-7">
                  <div class="input-group">
                    <div class="input-group-addon"><i class="fa fa-search"></i></div>
                    <input type="text" class="form-control input-sm" id="history-search" placeholder="filter..." />
                  </div>
                </div>
              </div>
              <div style="background-color: #fdfdfd;" class="top-right history container" id="history-trail"></div>
            </div>
          </div>
        </div>
        <!-- END TOP RIGHT -->
        <!-- BOTTOM RIGHT -->
        <div id="bottom-right">
          <ul class="nav nav-tabs">
            <li class="active"><a href="#files" data-toggle="tab"><i class="fa fa-file-text-o"></i>&nbsp;Files</a></li>
            <li><a href="#plot-window" data-toggle="tab"><i class="fa fa-bar-chart"></i>&nbsp;Plots</a></li>
            <li><a href="#packages" data-toggle="tab"><i class="fa fa-archive"></i>&nbsp;Packages</a></li>
            <li><a href="#help" data-toggle="tab"><i class="fa fa-life-ring"></i>&nbsp;Help</a></li>
          </ul>
          <div id="bottomRightTabContent" class="tab-content">
            <!-- File Nav -->
            <div id="files" class="tab-pane active in" style="height: 100%;">
              <div id="working-directory" class="list-group" style="margin-bottom: 0px;"></div>
              <div id="file-list" class="list-group" style="max-height: 100%; overflow: scroll; margin-bottom: 0px;">
              </div>
            </div>
            <!-- End File Nav -->
            <!-- Plot viewer -->
            <div class="tab-pane" id="plot-window">
              &nbsp;
              <a onclick="previousPlot();" class="label label-primary" title="Prevous Plot"><i class="fa fa-caret-left"></i></a>
              <a onclick="nextPlot()" class="label label-primary" title="Next Plot"><i class="fa fa-caret-right"></i></a>
              <a onclick="showPlot();" class="label label-primary" title="Zoom In"><i class="fa fa-arrows-alt"></i></a>
              <a onclick="savePlot();" class="label label-primary" title="Export Plot" download><i class="fa fa-floppy-o"></i></a>
              <a onclick="deletePlot();" class="label label-primary" title="Delete Plot"><i class="fa fa-trash-o"></i></a>
              <div id="plots">
              </div>
            </div>
            <!-- End Plot viewer -->
            <!-- Packages Viewer -->
            <div class="tab-pane" id="packages">
              <div class="row">
                <div class="col-sm-4">
                  <!--
                  <a class="label label-primary" title=""><i class="fa fa-download"></i>&nbsp;&nbsp;Install Packages</a>
                  <a class="label label-warning" title=""><i class="fa fa-refresh"></i>&nbsp;&nbsp;Update Packages</a>
                  -->
                </div>
                <div class="col-sm-5 col-sm-offset-3">
                  <div class="input-group">
                    <div class="input-group-addon"><i class="fa fa-search"></i></div>
                    <input type="text" class="form-control input-sm" id="pkg-search" placeholder="(i.e. pandas, Flask)" />
                  </div>
                </div>
              </div>
              <table class="table table-bordered" style="table-layout: fixed; margin-bottom: 0px;">
                <thead>
                  <tr>
                    <th>package</th>
                    <th>version</th>
                  </tr>
                </thead>
              </table>
              <div id="packages-container" style="max-height: 400px; overflow: auto;">
                <table class="table table-bordered" style="table-layout: fixed;">
                  <tbody id="packages-rows">
                  </tbody>
              </table>
              </div>
            </div>
            <!-- Packages Viewer -->
            <!-- Help -->
            <div class="tab-pane" id="help">
              <pre style="font-size: 10px; background-color: #fdfdfd; overflow: auto;" id="help-content"><i>run help(...) for more info</i></pre>
            </div>
            <!-- End Help -->
          </div>
          </div>
        </div>
        <!-- END BOTTOM RIGHT -->
    </div>
  </div>
  <script type="text/javascript" src="../src/editors.js"></script>
  <script type="text/javascript" src="../src/console.js"></script>
  <!-- end main section -->
  <script type="text/javascript">
    // resizeable panes
    $("#pane-container").height($(window).height());

    $("#pane-container").split({
      orientation: 'vertical',
      limit: 100,
      position:'50%'
    });

    $("#right-column").split({
      orientation: 'horizontal',
      limit: 100
    });

    $("#left-column").split({
      orientation: 'horizontal',
      limit: 100
    });

    // on resize w/ gray bars, recalibrate
    $(document.documentElement).bind('mouseup.splitter touchend.splitter touchleave.splitter touchcancel.spliter', function(e) {
      calibratePanes();
    });

    window.onresize = function(evt) {
      calibratePanes();
    };

    function calibratePanes() {
      $("#pane-container").height($(window).height());
      // Top Left
      var topLeftHeight = $("#top-left").height();
      var offset = $("#top-left #editorsTab").height() + 2;
      $("#top-left #editors").height(topLeftHeight - offset);

      // Bottom Left
      var bottomLeftHeight = $("#bottom-left").height();
      // var offset = $("#bottom-left .panel-heading").height() + 1;
      $("#console").height(bottomLeftHeight);
      // TODO: this is getting called constantly
      // setConsoleWidth($("#console").width());

      // Top Right
      var offset = $("#top-right ul").height() + 1;
      $("#environment").height($("#top-right").height() - offset);
      $("#history").height($("#top-right").height() - offset);
      $("#vars").height($("#top-right").height()*.7);

      // Bottom Right
      var tabOffset = $("#bottom-right .nav-tabs").height() + 1;
      $("#bottomRightTabContent").height($("#bottom-right").height() - tabOffset);
      // files
      $("#file-list").height($("#bottomRightTabContent").height() - $("#working-directory").height());
      // packages
      $("#packages").height($("#bottom-right").height() - tabOffset);
      var offset = 42 + 30 + 1; // $("#packages table").first().height() + $("#packages .row").first().height() + 1;
      $("#packages-container").height($("#packages").height() - offset);

      // plots
      $("#plot-window").height($("#bottom-right").height() - tabOffset);
      var offset = offset + 25; //13;
      $("#plots img").css("max-height", $("#bottom-right").height() - offset);
      // help
      $("#help-content").parent().height($("#bottom-right").height() - tabOffset);
      $("#help-content").height($("#bottom-right").height() - tabOffset);

    }


    // Tab stuff
    $("#add-tab").click(function(e) {
      e.preventDefault();
      var id;
      if ($("#editors .editor").length) {
        id = parseInt($("#editors .editor").last().attr("id").split("-")[1]) + 1;
      } else {
        id = 1;
      }
      var editor_tab_html = editor_tab_template({ n: id, name: "Untitled-" + id + ".py", isFirst: id==0});
      var editor_html = editor_template({ n: id });

      $(editor_tab_html).insertBefore($("#add-tab").parent());
      $("#editors").append(editor_html);
      createEditor("editor-" + id);
      // set to the active tab
      $("#editor-tab-" + id + " .editor-tab-a").click();
      if (id!="preferences") {
        ace.edit("editor-" + id).focus();
      }
      return false;
    });

    function closeActiveTab(n) {
      if (! $("#editor-tab-" + n + " .unsaved").hasClass("hide")) {
        remote.require('dialog').showMessageBox({
          type: "warning",
          buttons: ["Save", "Don't Save", "Cancel"],
          message: "Do you want to save the changes you've made to this file?",
          detail: "Your changes will be discarded otherwise."
        }, function(reply) {
          if (reply==0) {
            // save
            saveEditor(ace.edit("editor-" + n), null, function() {
              $("#editorsTab .editor-tab-a").first().click();
              $("#editor-tab-" + n).remove();
              $("#editor-tab-pane-" + n).remove();
            });
          } else if (reply==1) {
            // don't save
            $("#editorsTab .editor-tab-a").first().click();
            $("#editor-tab-" + n).remove();
            $("#editor-tab-pane-" + n).remove();
          } else {
            // do nothing
            return;
          }
        });
      } else {
        $("#editor-tab-" + n).remove();
        $("#editor-tab-pane-" + n).remove();
        $("#editorsTab .editor-tab-a").first().click();
      }
    }

    // Plots
    function previousPlot() {
      var currentPlot = $("#plots .active");
      if ($("#plots .active").prev().length) {
        $("#plots .active").prev().addClass("active").removeClass("hide");
        $(currentPlot).removeClass("active").addClass("hide");
      }
    }

    function nextPlot() {
      var currentPlot = $("#plots .active");
      if ($("#plots .active").next().length) {
        $("#plots .active").next().addClass("active").removeClass("hide");
        $(currentPlot).removeClass("active").addClass("hide");
      }
    }

    function deletePlot() {
      var currentPlot = $("#plots .active")
      if ($("#plots .active").next().length) {
        $("#plots .active").next().addClass("active").removeClass("hide");
      } else if ($("#plots .active").prev().length) {
        $("#plots .active").prev().addClass("active").removeClass("hide");
      }
      $(currentPlot).remove();
    }

    $('#pkg-search').on('input', function() {
      var query = $(this).val().toLowerCase();
      if (query=="") {
        $("#packages-rows tr").removeClass("hide");
      } else {
        $("#packages-rows tr").each(function(i, pkg) {
          var packageName = $("td", pkg).first().text().toLowerCase();
          if (packageName.indexOf(query) >= 0) {
            $(this).removeClass("hide");
          } else {
            $(this).addClass("hide");
          }
        });
      }
    });

    $('#history-search').on('input', function() {
      var query = $(this).val().toLowerCase();
      if (query=="") {
        $("#history-trail p").removeClass("hide");
      } else {
        $("#history-trail p").each(function(i, cmd) {
          var cmdText = $(cmd).text().toLowerCase();
          if (cmdText.indexOf(query) >= 0) {
            $(this).removeClass("hide");
          } else {
            $(this).addClass("hide");
          }
        });
      }
    });

  </script>

  <script type="text/javascript" src="../src/script.js"></script>
  <script type="text/javascript" src="../src/preferences.js"></script>
  <script type="text/javascript" src="../src/menu.js"></script>
  <script type="text/javascript">
    // not sure why but this needs to happen last
    calibratePanes();
    // should always be a first tab
    $("#add-tab").click();
  </script
</body>
</html>
